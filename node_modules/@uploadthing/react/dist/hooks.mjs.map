{"version":3,"sources":["../src/useUploadThing.ts","../src/utils/useEvent.ts","../src/utils/useFetch.ts"],"sourcesContent":["import { useState } from \"react\";\n\nimport { DANGEROUS__uploadFiles } from \"uploadthing/client\";\nimport type { ExpandedRouteConfig, FileRouter } from \"uploadthing/server\";\n\nimport { useEvent } from \"./utils/useEvent\";\nimport useFetch from \"./utils/useFetch\";\n\ntype EndpointMetadata = {\n  slug: string;\n  config: ExpandedRouteConfig;\n}[];\nconst useEndpointMetadata = (endpoint: string) => {\n  const { data } = useFetch<EndpointMetadata>(\"/api/uploadthing\");\n\n  // TODO: Log on errors in dev\n\n  return data?.find((x) => x.slug === endpoint);\n};\n\nexport const useUploadThing = <T extends string>({\n  endpoint,\n  onClientUploadComplete,\n  onUploadError,\n}: {\n  endpoint: T;\n  onClientUploadComplete?: (\n    res?: Awaited<ReturnType<typeof DANGEROUS__uploadFiles>>,\n  ) => void;\n  onUploadError?: (e: Error) => void;\n}) => {\n  const [isUploading, setUploading] = useState(false);\n\n  const permittedFileInfo = useEndpointMetadata(endpoint);\n\n  const startUpload = useEvent(async (files: File[]) => {\n    setUploading(true);\n    try {\n      const res = await DANGEROUS__uploadFiles(files, endpoint);\n      setUploading(false);\n      onClientUploadComplete?.(res);\n      return res;\n    } catch (e) {\n      setUploading(false);\n      onUploadError?.(e as Error);\n      return;\n    }\n  });\n  return {\n    startUpload,\n    isUploading,\n    permittedFileInfo,\n  } as const;\n};\n\nexport const generateReactHelpers = <TRouter extends FileRouter>() => {\n  type TRouterKey = keyof TRouter extends string ? keyof TRouter : string;\n\n  return {\n    useUploadThing: useUploadThing<TRouterKey>,\n    uploadFiles: DANGEROUS__uploadFiles<TRouterKey>,\n  } as const;\n};\n\nexport type FullFile = {\n  file: File;\n  contents: string;\n};\n","// Ripped from https://github.com/scottrippey/react-use-event-hook\nimport React from \"react\";\n\ntype AnyFunction = (...args: any[]) => any;\n\n/**\n * Suppress the warning when using useLayoutEffect with SSR. (https://reactjs.org/link/uselayouteffect-ssr)\n * Make use of useInsertionEffect if available.\n */\nconst useInsertionEffect =\n  typeof window !== \"undefined\"\n    ? // useInsertionEffect is available in React 18+\n      React.useInsertionEffect || React.useLayoutEffect\n    : () => {};\n\n/**\n * Similar to useCallback, with a few subtle differences:\n * - The returned function is a stable reference, and will always be the same between renders\n * - No dependency lists required\n * - Properties or state accessed within the callback will always be \"current\"\n */\nexport function useEvent<TCallback extends AnyFunction>(\n  callback: TCallback,\n): TCallback {\n  // Keep track of the latest callback:\n  const latestRef = React.useRef<TCallback>(\n    useEvent_shouldNotBeInvokedBeforeMount as any,\n  );\n  useInsertionEffect(() => {\n    latestRef.current = callback;\n  }, [callback]);\n\n  // Create a stable callback that always calls the latest callback:\n  // using useRef instead of useCallback avoids creating and empty array on every render\n  const stableRef = React.useRef<TCallback>(null as any);\n  if (!stableRef.current) {\n    stableRef.current = function (this: any) {\n      return latestRef.current.apply(this, arguments as any);\n    } as TCallback;\n  }\n\n  return stableRef.current;\n}\n\n/**\n * Render methods should be pure, especially when concurrency is used,\n * so we will throw this error if the callback is called while rendering.\n */\nfunction useEvent_shouldNotBeInvokedBeforeMount() {\n  throw new Error(\n    \"INVALID_USEEVENT_INVOCATION: the callback from useEvent cannot be invoked before the component has mounted.\",\n  );\n}\n","// Ripped from https://usehooks-ts.com/react-hook/use-fetch\nimport { useEffect, useReducer, useRef } from \"react\";\n\ninterface State<T> {\n  data?: T;\n  error?: Error;\n}\n\ntype Cache<T> = { [url: string]: T };\n\n// discriminated union type\ntype Action<T> =\n  | { type: \"loading\" }\n  | { type: \"fetched\"; payload: T }\n  | { type: \"error\"; payload: Error };\n\nfunction useFetch<T = unknown>(url?: string, options?: RequestInit): State<T> {\n  const cache = useRef<Cache<T>>({});\n\n  // Used to prevent state update if the component is unmounted\n  const cancelRequest = useRef<boolean>(false);\n\n  const initialState: State<T> = {\n    error: undefined,\n    data: undefined,\n  };\n\n  // Keep state logic separated\n  const fetchReducer = (state: State<T>, action: Action<T>): State<T> => {\n    switch (action.type) {\n      case \"loading\":\n        return { ...initialState };\n      case \"fetched\":\n        return { ...initialState, data: action.payload };\n      case \"error\":\n        return { ...initialState, error: action.payload };\n      default:\n        return state;\n    }\n  };\n\n  const [state, dispatch] = useReducer(fetchReducer, initialState);\n\n  useEffect(() => {\n    // Do nothing if the url is not given\n    if (!url) return;\n\n    cancelRequest.current = false;\n\n    const fetchData = async () => {\n      dispatch({ type: \"loading\" });\n\n      // If a cache exists for this url, return it\n      if (cache.current[url]) {\n        dispatch({ type: \"fetched\", payload: cache.current[url] });\n        return;\n      }\n\n      try {\n        const response = await fetch(url, options);\n        if (!response.ok) {\n          throw new Error(response.statusText);\n        }\n\n        const data = (await response.json()) as T;\n        cache.current[url] = data;\n        if (cancelRequest.current) return;\n\n        dispatch({ type: \"fetched\", payload: data });\n      } catch (error) {\n        if (cancelRequest.current) return;\n\n        dispatch({ type: \"error\", payload: error as Error });\n      }\n    };\n\n    void fetchData();\n\n    // Use the cleanup function for avoiding a possibly...\n    // ...state update after the component was unmounted\n    return () => {\n      cancelRequest.current = true;\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [url]);\n\n  return state;\n}\n\nexport default useFetch;\n"],"mappings":";;;AAAA,SAAS,gBAAgB;AAEzB,SAAS,8BAA8B;;;ACDvC,OAAO,WAAW;AAQlB,IAAM,qBACJ,OAAO,WAAW;AAAA;AAAA,EAEd,MAAM,sBAAsB,MAAM;AAAA,IAClC,MAAM;AAAC;AAQN,SAAS,SACd,UACW;AAEX,QAAM,YAAY,MAAM;AAAA,IACtB;AAAA,EACF;AACA,qBAAmB,MAAM;AACvB,cAAU,UAAU;AAAA,EACtB,GAAG,CAAC,QAAQ,CAAC;AAIb,QAAM,YAAY,MAAM,OAAkB,IAAW;AACrD,MAAI,CAAC,UAAU,SAAS;AACtB,cAAU,UAAU,WAAqB;AACvC,aAAO,UAAU,QAAQ,MAAM,MAAM,SAAgB;AAAA,IACvD;AAAA,EACF;AAEA,SAAO,UAAU;AACnB;AAMA,SAAS,yCAAyC;AAChD,QAAM,IAAI;AAAA,IACR;AAAA,EACF;AACF;;;ACnDA,SAAS,WAAW,YAAY,cAAc;AAe9C,SAAS,SAAsB,KAAc,SAAiC;AAC5E,QAAM,QAAQ,OAAiB,CAAC,CAAC;AAGjC,QAAM,gBAAgB,OAAgB,KAAK;AAE3C,QAAM,eAAyB;AAAA,IAC7B,OAAO;AAAA,IACP,MAAM;AAAA,EACR;AAGA,QAAM,eAAe,CAACA,QAAiB,WAAgC;AACrE,YAAQ,OAAO,MAAM;AAAA,MACnB,KAAK;AACH,eAAO,EAAE,GAAG,aAAa;AAAA,MAC3B,KAAK;AACH,eAAO,EAAE,GAAG,cAAc,MAAM,OAAO,QAAQ;AAAA,MACjD,KAAK;AACH,eAAO,EAAE,GAAG,cAAc,OAAO,OAAO,QAAQ;AAAA,MAClD;AACE,eAAOA;AAAA,IACX;AAAA,EACF;AAEA,QAAM,CAAC,OAAO,QAAQ,IAAI,WAAW,cAAc,YAAY;AAE/D,YAAU,MAAM;AAEd,QAAI,CAAC;AAAK;AAEV,kBAAc,UAAU;AAExB,UAAM,YAAY,YAAY;AAC5B,eAAS,EAAE,MAAM,UAAU,CAAC;AAG5B,UAAI,MAAM,QAAQ,GAAG,GAAG;AACtB,iBAAS,EAAE,MAAM,WAAW,SAAS,MAAM,QAAQ,GAAG,EAAE,CAAC;AACzD;AAAA,MACF;AAEA,UAAI;AACF,cAAM,WAAW,MAAM,MAAM,KAAK,OAAO;AACzC,YAAI,CAAC,SAAS,IAAI;AAChB,gBAAM,IAAI,MAAM,SAAS,UAAU;AAAA,QACrC;AAEA,cAAM,OAAQ,MAAM,SAAS,KAAK;AAClC,cAAM,QAAQ,GAAG,IAAI;AACrB,YAAI,cAAc;AAAS;AAE3B,iBAAS,EAAE,MAAM,WAAW,SAAS,KAAK,CAAC;AAAA,MAC7C,SAAS,OAAP;AACA,YAAI,cAAc;AAAS;AAE3B,iBAAS,EAAE,MAAM,SAAS,SAAS,MAAe,CAAC;AAAA,MACrD;AAAA,IACF;AAEA,SAAK,UAAU;AAIf,WAAO,MAAM;AACX,oBAAc,UAAU;AAAA,IAC1B;AAAA,EAEF,GAAG,CAAC,GAAG,CAAC;AAER,SAAO;AACT;AAEA,IAAO,mBAAQ;;;AF7Ef,IAAM,sBAAsB,CAAC,aAAqB;AAChD,QAAM,EAAE,KAAK,IAAI,iBAA2B,kBAAkB;AAI9D,SAAO,6BAAM,KAAK,CAAC,MAAM,EAAE,SAAS;AACtC;AAEO,IAAM,iBAAiB,CAAmB;AAAA,EAC/C;AAAA,EACA;AAAA,EACA;AACF,MAMM;AACJ,QAAM,CAAC,aAAa,YAAY,IAAI,SAAS,KAAK;AAElD,QAAM,oBAAoB,oBAAoB,QAAQ;AAEtD,QAAM,cAAc,SAAS,OAAO,UAAkB;AACpD,iBAAa,IAAI;AACjB,QAAI;AACF,YAAM,MAAM,MAAM,uBAAuB,OAAO,QAAQ;AACxD,mBAAa,KAAK;AAClB,uEAAyB;AACzB,aAAO;AAAA,IACT,SAAS,GAAP;AACA,mBAAa,KAAK;AAClB,qDAAgB;AAChB;AAAA,IACF;AAAA,EACF,CAAC;AACD,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;AAEO,IAAM,uBAAuB,MAAkC;AAGpE,SAAO;AAAA,IACL;AAAA,IACA,aAAa;AAAA,EACf;AACF;","names":["state"]}